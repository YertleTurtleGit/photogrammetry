class StereoDepthHelper{static async getDepthMapping(e,t,o=51,r=7){return new Promise((a=>{setTimeout((async()=>{e=await StereoDepthHelper.preprocessImage(e),t=await StereoDepthHelper.preprocessImage(t);const h={width:e.width,height:e.height},n=new GLSL.Shader(h);n.bind();const i=GLSL.render(GLSL.Image.load(e)).getPixelArray();n.purge();const s=new GLSL.Shader(h);s.bind();const d=GLSL.render(GLSL.Image.load(t)).getPixelArray();s.purge();const l=StereoDepthHelper.getImageChunks(i,h,o),g=document.createElement("canvas");g.width=h.width,g.height=h.height;const c=g.getContext("2d"),p=document.createElement("canvas");p.width=h.width,p.height=2*h.height;const w=p.getContext("2d");document.body.appendChild(g),document.body.appendChild(p),w.drawImage(e,0,0,h.width,h.height),w.drawImage(t,0,h.height,h.width,h.height);for(let e=0;e<l.length;e++){const t=l[e],a={x:t.offset.x+o,y:t.offset.y+o};StereoDepthHelper.getBestNeedleChunkFit(t,d,h,r).then((e=>{if(e){const r={x:a.x-e.x,y:a.y-e.y},n=Math.sqrt(Math.pow(r.x,2)+Math.pow(r.y,2)),i=String(255-Math.round(Math.min(255,n)));w.beginPath(),w.moveTo(a.x,a.y),w.strokeStyle="red",w.lineTo(e.x,e.y+h.height),w.stroke(),c.fillStyle="rgb("+i+", "+i+", "+i+")",c.fillRect(t.offset.x,t.offset.y,o,o)}}))}a(null)}))}))}static async preprocessImage(e){const t=new GLSL.Shader({width:e.width,height:e.height});t.bind();const o=new GLSL.Image(e),r=GLSL.render(o.applyFilter([[-1,-1,-1],[-1,8.5,-1],[-1,-1,-1]])).getJsImage();return t.purge(),r}static async getBestNeedleChunkFit(e,t,o,r){return new Promise((a=>{setTimeout((()=>{const h=Math.sqrt(e.data.length/4),n=(h-1)/2;let i,s=Number.MAX_VALUE,d=0;for(let l=h;l<o.width;l++)for(let g=h;g<o.height;g++){let c=0;for(let a=0;a<h;a+=r)for(let i=0;i<h;i+=r){const r=4*(l+a-n+(g+i-n)*o.width),s=t[r+0],d=t[r+1],p=t[r+2],w=4*(a+i*h),m=e.data[w+0],u=e.data[w+1],f=e.data[w+2];c+=Math.abs(s-m)+Math.abs(d-u)+Math.abs(p-f)}if(c<s?(s=c,i={x:l,y:g}):c===s&&d++,0===s)return console.log({bestFitCoordinate:i,lowestAberrance:s}),void a(i)}console.log({bestFitCoordinate:i,lowestAberrance:s,twinCount:d}),a(i)}))}))}static getImageChunks(e,t,o){const r=[];let a=0;for(let h=0;h+o<t.width;h+=o)for(let n=0;n+o<t.height;n+=o){r.push({data:[],offset:{x:h,y:n}});for(let i=0;i<o;i++)for(let s=0;s<o;s++){const o=4*(i+h+(s+n)*t.width),d=e[o+0],l=e[o+1],g=e[o+2],c=e[o+3];r[a].data.push(d,l,g,c)}a++}return r}}
