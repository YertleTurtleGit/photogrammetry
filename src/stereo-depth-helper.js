class StereoDepthHelper{static async getDepthMapping(e,t,o=51,r=7){return new Promise((r=>{setTimeout((async()=>{e=await StereoDepthHelper.preprocessImage(e),t=await StereoDepthHelper.preprocessImage(t);const a={width:e.width,height:e.height},h=new GLSL.Shader(a);h.bind();const n=GLSL.render(GLSL.Image.load(e)).getPixelArray();h.purge();const i=new GLSL.Shader(a);i.bind();const s=GLSL.render(GLSL.Image.load(t)).getPixelArray();i.purge();const d=StereoDepthHelper.getImageChunks(n,a,o),l=document.createElement("canvas");l.width=a.width,l.height=a.height;const g=l.getContext("2d"),c=document.createElement("canvas");c.width=a.width,c.height=2*a.height;const p=c.getContext("2d");document.body.appendChild(l),document.body.appendChild(c),p.drawImage(e,0,0,a.width,a.height),p.drawImage(t,0,a.height,a.width,a.height);for(let e=0;e<d.length;e++){const t=d[e],r={x:t.offset.x+o,y:t.offset.y+o};StereoDepthHelper.getBestNeedleChunkFit(t,s,a).then((e=>{if(e){const h={x:r.x-e.x,y:r.y-e.y},n=Math.sqrt(Math.pow(h.x,2)+Math.pow(h.y,2)),i=String(255-Math.round(Math.min(255,n)));p.beginPath(),p.moveTo(r.x,r.y),p.strokeStyle="red",p.lineTo(e.x,e.y+a.height),p.stroke(),g.fillStyle="rgb("+i+", "+i+", "+i+")",g.fillRect(t.offset.x,t.offset.y,o,o)}}))}r(null)}))}))}static async preprocessImage(e){const t=new GLSL.Shader({width:e.width,height:e.height});t.bind();const o=new GLSL.Image(e),r=GLSL.render(o.applyFilter([[-1,-1,-1],[-1,8.5,-1],[-1,-1,-1]])).getJsImage();return t.purge(),r}static async getBestNeedleChunkFit(e,t,o){return new Promise((r=>{setTimeout((()=>{const a=Math.sqrt(e.data.length/4);let h,n=Number.MAX_VALUE,i=0;for(let s=a;s<o.width;s++)for(let d=a;d<o.height;d++){let l=0;for(let r=0;r<a;r+=10)for(let h=0;h<a;h+=10){const n=s+r,i=d+h,g=Math.round(n+i*o.width),c=t[g+0],p=t[g+1],w=t[g+2],u=Math.round(r+h*a),m=e.data[u+0],f=e.data[u+1],y=e.data[u+2];l+=Math.abs(c-m)+Math.abs(p-f)+Math.abs(w-y)}if(l<n?(n=l,h={x:s,y:d}):l===n&&i++,0===n)return console.log({bestFitCoordinate:h,lowestAberrance:n}),void r(h)}console.log({bestFitCoordinate:h,lowestAberrance:n,twinCount:i}),r(h)}))}))}static getImageChunks(e,t,o){const r=[];let a=0;for(let h=0;h+o<t.width;h+=o)for(let n=0;n+o<t.height;n+=o){r.push({data:[],offset:{x:h,y:n}});for(let i=0;i<o;i++)for(let s=0;s<o;s++){const o=4*(i+h+(s+n)*t.width),d=e[o+0],l=e[o+1],g=e[o+2],c=e[o+3];r[a].data.push(d,l,g,c)}a++}return r}}
