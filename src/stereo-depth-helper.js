class StereoDepthHelper{static async getDepthMapping(e,t,o=51,r=7){return new Promise((r=>{setTimeout((async()=>{e=await StereoDepthHelper.preprocessImage(e),t=await StereoDepthHelper.preprocessImage(t);const a={width:e.width,height:e.height},h=new GLSL.Shader(a);h.bind();const n=GLSL.render(GLSL.Image.load(e)).getPixelArray();h.purge();const i=new GLSL.Shader(a);i.bind();const s=GLSL.render(GLSL.Image.load(t)).getPixelArray();i.purge();const d=StereoDepthHelper.getImageChunks(n,a,o),l=document.createElement("canvas");l.width=a.width,l.height=a.height;const g=l.getContext("2d"),c=document.createElement("canvas");c.width=a.width,c.height=2*a.height;const p=c.getContext("2d");document.body.appendChild(l),document.body.appendChild(c),p.drawImage(e,0,0,a.width,a.height),p.drawImage(t,0,a.height,a.width,a.height);for(let e=0;e<d.length;e++){const t=d[e],r={x:t.offset.x+o,y:t.offset.y+o};StereoDepthHelper.getBestNeedleChunkFit(t,s,a).then((e=>{if(e){const h={x:r.x-e.x,y:r.y-e.y},n=Math.sqrt(Math.pow(h.x,2)+Math.pow(h.y,2)),i=String(255-Math.round(Math.min(255,n)));p.beginPath(),p.moveTo(r.x,r.y),p.strokeStyle="red",p.lineTo(e.x,e.y+a.height),p.stroke(),g.fillStyle="rgb("+i+", "+i+", "+i+")",g.fillRect(t.offset.x,t.offset.y,o,o)}}))}r(null)}))}))}static async preprocessImage(e){const t=new GLSL.Shader({width:e.width,height:e.height});t.bind();const o=new GLSL.Image(e),r=GLSL.render(o.applyFilter([[-1,-1,-1],[-1,8.5,-1],[-1,-1,-1]])).getJsImage();return t.purge(),r}static async getBestNeedleChunkFit(e,t,o){return new Promise((r=>{setTimeout((()=>{const a=Math.sqrt(e.data.length/4),h=(a-1)/2;let n,i=Number.MAX_VALUE,s=0;for(let d=a;d<o.width;d++)for(let l=a;l<o.height;l++){let g=0;for(let r=0;r<a;r+=10)for(let n=0;n<a;n+=10){const i=4*(d+r-h+(l+n-h)*o.width),s=t[i+0],c=t[i+1],p=t[i+2],w=4*(r+n*a),m=e.data[w+0],u=e.data[w+1],f=e.data[w+2];g+=Math.abs(s-m)+Math.abs(c-u)+Math.abs(p-f)}if(g<i?(i=g,n={x:d,y:l}):g===i&&s++,0===i)return console.log({bestFitCoordinate:n,lowestAberrance:i}),void r(n)}console.log({bestFitCoordinate:n,lowestAberrance:i,twinCount:s}),r(n)}))}))}static getImageChunks(e,t,o){const r=[];let a=0;for(let h=0;h+o<t.width;h+=o)for(let n=0;n+o<t.height;n+=o){r.push({data:[],offset:{x:h,y:n}});for(let i=0;i<o;i++)for(let s=0;s<o;s++){const o=4*(i+h+(s+n)*t.width),d=e[o+0],l=e[o+1],g=e[o+2],c=e[o+3];r[a].data.push(d,l,g,c)}a++}return r}}
